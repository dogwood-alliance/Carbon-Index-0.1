---
title: "Forest Carbon Index Report"
output: html_document
runtime: shiny
params:
  data: NA
  n: NA
  stateText: NA
  user: NA
  printcode: false
---

```{r, setup, include=FALSE}
knitr::opts_chunk$set(echo = params$printcode, scipen=999)
```

```{r, warning = FALSE, message = FALSE}
library(tidyverse)
library(dplyr)
library(ggplot2)
library(modelr)
library(shiny)
```

```{r echo= FALSE}
#subsetting data based on state picked
state.data<- subset(params$data, State == params$stateText)

stTotalAc <- format( round( subset(state.data,
                      Stand_Origin %in% "Total" &
                      Stand_Age %in% "Total" &
                      Forest.type.group %in% "Total")[,"ac"], #endsubset
                    0), #endround 
                big.mark=",")

stTotalC <- format( round( subset(state.data, 
                    Stand_Origin %in% "Total" &
                    Stand_Age %in% "Total" &
                    Forest.type.group %in% "Total")[,"tC"], #endsubset
                  0), #endround 
              big.mark=",")

stTotalFCI <- subset(state.data, 
                               Stand_Origin %in% "Total" &
                               Stand_Age %in% "Total" &
                               Forest.type.group %in% "Total")[,"tC_ac"]
            
```
## `r params$stateText `  


The great state of `r params$stateText ` has `r stTotalAc` total acres of forestland, which store `r stTotalC` tons of carbon, for a total Forest Carbon Index (FCI) of `r stTotalFCI`. 

## Forest Types  
```{r echo= FALSE}
stSumFt<- n_distinct(select(subset(state.data, Forest.type.group!= "Total"), Forest.type.group))

stMaxAc_FT<- subset(state.data, Stand_Origin== "Total" & Stand_Age== "Total" & 
        Forest.type.group!= "Total") %>% select(ac) %>% max() 

formatted_MaxAc<- format(stMaxAc_FT, big.mark = ",")

stMaxAc_Name<- as.character(subset(state.data$Forest.type.group, state.data$ac== stMaxAc_FT)[1])

stMaxFCI_FT<- subset(state.data, Stand_Origin== "Total" & Stand_Age== "Total" & 
        Forest.type.group!= "Total") %>% select(tC_ac) %>% max()

stMaxFCI_Name<- as.character(subset(state.data$Forest.type.group, state.data$tC_ac== stMaxFCI_FT)[1])
```


```{r echo= FALSE}
stMinAc_FT<- subset(state.data, Stand_Origin== "Total" & Stand_Age== "Total" & 
        Forest.type.group!= "Total") %>% select(ac) %>% min() 
    
formatted_MinAc<- format(stMinAc_FT, big.mark=",")

stMinAc_Name<- as.character(subset(state.data$Forest.type.group, state.data$ac== stMinAc_FT)[1])
    
stMinFCI_FT<- subset(state.data, Stand_Origin== "Total" & Stand_Age== "Total" & 
        Forest.type.group!= "Total") %>% select(tC_ac) %>% min()

stMinFCI_Name<- as.character(subset(state.data$Forest.type.group, state.data$tC_ac== stMinFCI_FT)[1])

stTotalFCI <- format(subset(state.data, Stand_Origin== "Total" & Stand_Age=="Total" & Forest.type.group== "Total")[,"tC_ac"], big.mark=",")
```

`r params$stateText ` has `r stSumFt` forest types across the state, with `r formatted_MaxAc` acres being of the `r stMaxAc_Name`. There are only `r formatted_MinAc` acres of the `r stMinAc_Name`. The `r stMaxFCI_Name` has the highest FCI at `r stMaxFCI_FT` while the `r stMinFCI_Name` has the lowest FCI at `r stMinFCI_FT`.  Overall, the total FCI in `r params$stateText ` is `r stTotalFCI `.


```{r echo= FALSE, fig.width= 6, fig.height= 4}
##subsetting data to include only Totals values
totals.data<- subset(state.data, Stand_Origin== "Total" & Stand_Age== "Total" & 
        Forest.type.group!= "Total") 

#Pie charts of acreage and tons of carbon by forest type
ft.ac.pie<- ggplot(totals.data, aes(x="", y= ac, fill= Forest.type.group)) +
  geom_bar(width=1, stat= "identity") + coord_polar("y", start=0) +
  labs(title= "Acreage per forest type", fill= "Forest Type") +
  theme_void()

ft.tC.pie<- ggplot(totals.data, aes(x="", y= tC, fill= Forest.type.group)) +
  geom_bar(width=1, stat= "identity") + coord_polar("y", start=0) +
  labs(title= "Tons of carbon stored per forest type", fill= "Forest Type") +
  theme_void()

ft.ac.pie
ft.tC.pie
```

```{r echo= FALSE}
if (params$user== "Scientist"){
  totals.table<- totals.data %>% select(-c(Stand_Age, Stand_Origin, State)) %>% arrange((desc(tC))) %>%
  rename("Forest Type"= Forest.type.group, "Carbon Stored (tons)"= tC, "Acreage"= ac, "Forest Carbon Index"= 
  tC_ac) %>% datatable()
} else{
  totals.table<- ""
}
totals.table
```


## Fake Forests  
```{r echo= FALSE}
stFCINatural<- subset(state.data, Stand_Origin== "Natural" & Stand_Age== "Total" & Forest.type.group== 
    "Total")[, "tC_ac"]

stFCIPlanted<- subset(state.data, Stand_Origin== "Planted" & Stand_Age== "Total" & Forest.type.group== 
    "Total")[, "tC_ac"]

stPlantedAc<-subset(state.data, Stand_Origin== "Planted" & Stand_Age== "Total" & Forest.type.group== 
    "Total")[, "ac"]

formatted_PlantedAc<- format(stPlantedAc, big.mark = ",")

stPlantedC<- subset(state.data, Stand_Origin== "Planted" & Stand_Age== "Total" & Forest.type.group== 
    "Total")[, "tC"]

stMissedCarbon<- format(((stPlantedAc * stFCINatural)- stPlantedC), big.mark = ",")

additional<- stFCINatural - stFCIPlanted

totalAc<- subset(state.data, Stand_Origin %in% "Total" &
                      Stand_Age %in% "Total" &
                      Forest.type.group %in% "Total")[,"ac"]

percentage<- round((stPlantedAc/totalAc)*100, 2)

cars<- format((((stPlantedAc * stFCINatural)- stPlantedC)*(44/12) * 0.192608384), big.mark = ",")
```

On average, natural forests in `r params$stateText ` store `r additional` additional tons of carbon per acre than artificially regenerated forests. Across the state, there are `r formatted_PlantedAc` acres of plantations, representing `r percentage`% of total forestland.  

If those acres of planted forests had been naturally regenerated, they would currently be storing approximately  `r stMissedCarbon` more tons of carbon, equivalent to an additional `r cars` passenger vehicles on the road for one year. 

```{r echo= FALSE}
if (params$user== "Scientist"){
  cat("*The conversion factor from tons of carbon to passenger vehicles was taken directy from the EPA's Greenhouse Gas Equivalencies Calculator, which can be found here: https://www.epa.gov/energy/greenhouse-gas-equivalencies-calculator", "\n", "Thus, the amount of passenger vehicles equal to the amount of additional carbon that would have been stored if the planted forests were of natural origin was calculated as follows: ", "\n", stMissedCarbon, " x 44/12 x 0.192608384")
}
```


```{r echo= FALSE}
ft.data<- subset(state.data, Stand_Origin!= "Total" & Stand_Age== "Total")  %>% 
  mutate_if(is.numeric, ~replace(., is.na(.), 0))

fake.forests.bar<- ggplot(ft.data, aes(x= Forest.type.group, y= tC_ac, fill= Stand_Origin)) +
  geom_col(position= position_dodge()) + 
  ggtitle("FCI per Forest Type Group") +
  labs(x= "Forest Type Group", y= "Forest Carbon Index (FCI)\n", fill= "Stand Origin") +
  geom_text(aes(label=tC_ac), vjust=2.2, color="white",position = position_dodge(0.9), size=2) +
  scale_fill_manual(values= c("#348045", "#B3DCBC")) + theme_minimal() +
  theme(
    plot.title= element_text(size= 20, face= "bold"),
    axis.text.x= element_text(angle= 45, size= 8, vjust= .99, hjust= .95, color= "black"),
    axis.title= element_text(size= 14),
    legend.title= element_text(size= 12),
    legend.text = element_text(size= 10),
    axis.text.y= element_text(size=10, color= "black"))

fake.forests.bar
```

```{r echo= FALSE}
if (params$user== "Scientist"){
  ft.table<- ft.data %>% select(-c(State, Stand_Age, tC, ac)) %>% arrange(Stand_Origin, desc(tC_ac)) %>% 
  rename("Forest Type"= Forest.type.group, "Forest Carbon Index"= tC_ac, "Stand Origin"= Stand_Origin) %>%  
  datatable()
} else{
  ft.table<- ""
}
ft.table
```

## How Does `r params$stateText ` Compare?  

```{r echo=FALSE}
ACrank<- subset(params$data, Stand_Origin== "Planted" & Stand_Age== "Total" & Forest.type.group== 
    "Total") %>% arrange((desc(ac))) %>% pull(State) %in% params$stateText %>% which 

TCrank<- subset(params$data, Stand_Origin== "Planted" & Stand_Age== "Total" & Forest.type.group== 
    "Total") %>% select(tC, State) %>% arrange((desc(tC))) %>% pull(State) %in% params$stateText %>% which 

FCIrank<- subset(params$data, Stand_Origin== "Planted" & Stand_Age== "Total" & Forest.type.group== 
    "Total") %>% select(tC_ac, State) %>% arrange((desc(tC_ac))) %>% pull(State) %in% params$stateText %>% which 
```

In the fourteen state region of the South, `r params$stateText ` ranks:   
  
* `r ACrank` of 11 in Acres of Forestland   

* `r TCrank` of 11 in Tons of Carbon Sequestered in Forestland  

* `r FCIrank` of 11 in Forest Carbon Index (FCI)  

Here’s how the forest types of `r params$stateText ` rank against other states:

Table: FCI Value, Forest Type Row, State Column

Table: TC Value, Forest Type Row, State Column

Table: AC Value, Forest Type Row, State Column

## Natural Climate Solutions

### Letting Forests Mature

**WHY**  

Planted forests (plantations) usually have a short “rotation” -- the number of years it takes for them to grow, be cut down, and have the area replanted. In commercial pine plantations, it can be as little as 20-25 years. In contrast, natural forests often remain uncut for longer, naturally store more carbon, and have the potential to transform into old growth forests that support more biodiversity and provide more ecosystem services. 

Every time an acre of forest is harvested, it releases carbon. If that acre is used for bioenergy, the carbon can be emitted in as little as 1-2 years. If that acre is used for more traditional forest products, like paper, pulp, or lumber, 86% of that carbon is emitted within 100 years, with just 14% remaining behind in finished products and landfills. Although plantations are generally intended for commercial harvest, a substantial amount of natural forests also get harvested every year. 

Contrary to common belief, forests do not stop or significantly slow in carbon sequestration when they are old. Instead, older forests continue to store carbon well beyond 100 years of age. In fact, the carbon uptake rate is remarkably similar for both younger and older forests. As shown in the graph below, the total FCI, or tons of carbon stored per acre, in `r params$stateText` becomes greater as forests age. 

```{r}
model.data<- subset(state.data, Stand_Age!= "Total") %>% na.omit()
model.data$Stand_Age<- factor(model.data$Stand_Age, levels= c("0-20 years", "21-40 years", "41-60 years", "61-80 years", "81-100 years", "100+ years"))

age.data<- subset(model.data, Stand_Origin== "Total" & Forest.type.group== "Total") %>% 
  mutate_at(vars(tC_ac), funs(round(., 0)))

age.bar<- ggplot(age.data, aes(x= Stand_Age, y= tC_ac)) +
  geom_col(fill= "darkolivegreen4") + 
  ggtitle("FCI per Forest Age Class") +
  labs(x= "Forest Age Class", y= "Forest Carbon Index (FCI)\n", fill= "Stand Origin") +
  geom_text(aes(label=tC_ac), vjust=2.2, color="white",position = position_dodge(0.9), size=4) + theme_minimal() +
  theme(
    plot.title= element_text(size= 20, face= "bold"),
    axis.text.x= element_text(size= 10, color= "black", vjust= .99),
    axis.title= element_text(size= 14),
    axis.text.y= element_text(size=10, color= "black"))
  
age.bar
```


**THE PAYOFF**  

Reducing the amount of forest harvest in `r params$stateText ` could improve carbon sequestration and contribute to the state’s natural climate solutions. In the data, this would be observed as allowing more forests to mature to the next age class. We can model this behavior by doing some simple table calculations, and predict what the increase in carbon would be if acres managed to successfully grow into the next age class.
```{r echo= FALSE}
#linear regression of effect on stand age and acreage on carbon storage
linear.mod<- lm(tC ~ Stand_Age + ac, data= model.data)

#function to calculate how much more carbon would be stored if a user inputted percentage of all forests were moved to the next age class

letForestsMature<- function(percentage){
  predict.data<- subset(model.data, Stand_Origin== "Total" & Forest.type.group== "Total") 
  more<- 0
  for (x in predict.data$Stand_Age){
    idx<- which(predict.data$Stand_Age== x)
    ac.val<- (predict.data$ac[idx])
    decimal<- as.numeric(percentage/100)
    if(x!= "100+ years"){
      newdata<- data.frame(ac= ac.val*decimal,Stand_Age= predict.data$Stand_Age[idx+1])
      more<- more + predict(linear.mod, newdata, type="response")
    }
  }
  more
}

ten.old<- letForestsMature(10)
twenty.five.old<- letForestsMature(25)
fifty.old<- letForestsMature(50)
```

* If the state moved 10% of all forests to the next age class, it would result in an additional `r ten.old` tons of carbon sequestered in `r params$stateText `’s forests.  

* If the state moved 25% of all forests to the next age class, it would result in an additional `r twenty.five.old` tons of carbon sequestered in `r params$stateText `’s forests.  

* If the state moved 50% of all forests to the next age class, it would result in an additional `r fifty.old` tons of carbon sequestered in `r params$stateText `’s forests.  

```{r}
#Interactive Table: Current State, Value: Carbon, Row: Forest Type Group, Col: Age Class
#	Percentage slider 0-100. Takes X % of previous age class and sticks it in the next.
#Flat Table For Report: Benchmarks of 10, 25, 50%, same table output
sliderInput("percent_slider", label = "Percentage of forests moved to the next age class:",
              min = 0, max = 100, value = 10, step = 5)

renderText({
   paste("If the state moved ", input$percent_slider, "% of all forests to the next age class, it would result in an additional ", letForestsMature(input$percent_slider), " tons of carbon sequestered.")
})
```

```{r echo= FALSE}
if (params$user== "Scientist"){
  cat("*The above values were calculated by generating a linear model of tons of carbon stored based on forest acreage and age in the state. This model was then used to predict how much more carbon would be stored if x percent of each forest age class were moved to the next age class.")
}
```

### Letting Forests Regenerate Naturally

**WHY**  
Although planting trees does regenerate the area more quickly, there are lasting effects from those plantings that are seen in carbon sequestration. On average, natural forests in `r params$stateText ` store `r additional` additional tons of carbon per acre than artificially regenerated forests. This means that a naturally regenerated forest stand will, as a rule, store more carbon than an artificially regenerated (planted) stand. Beyond carbon benefits, natural regeneration also reduces the amount of pesticides, soil impaction, and water runoff that can occur after a forest harvest. 
```{r}
letForestsRegenerate<- function(percentage){
  model.data2<- subset(state.data, Stand_Origin!= "Total") %>% na.omit()
  decimal<- as.numeric(percentage/100)
  avg<- mean(model.data2$tC_ac[model.data2$Stand_Origin== "Natural"])
  acreage<- subset(state.data, Stand_Origin=="Planted" & Stand_Age=="Total" & Forest.type.group=="Total")[,"ac"]
  avg*acreage*decimal
}

ten.natural<- letForestsRegenerate(10)
twenty.five.natural<- letForestsRegenerate(25)
fifty.natural<-  letForestsRegenerate(50)
```

**THE PAYOFF**
Although we cannot choose individual acres, we can see the potential carbon sequestration difference if more acres were naturally instead of artificially regenerated.  

* If the state had 10% more naturally regenerated forests, its forests would sequester, on average, `r ten.natural` more tons of carbon.  

* If the state had 25% more naturally regenerated forests, its forests would sequester, on average, `r twenty.five.natural` more tons of carbon.  

* If the state had 50% more naturally regenerated forests, its forests would sequester, on average, `r fifty.natural` more tons of carbon.  

```{r echo= FALSE}
#Interactive Table: Current State, Value: Carbon, Row: Forest Type Group, Col: Stand Origin
#	Percentage slider 0-100. Takes X % of artificial and changes it to natural.

sliderInput("percent_slider2", label = "Percentage of forests moved to naturally regenerated:",
              min = 0, max = 100, value = 10, step = 5)
#Flat Table For Report: Benchmarks of 10, 25, 50%, same table output

renderText({
   paste("If the state moved ", input$percent_slider2, "% of artificially planted forests in the state to naturally regenerated, it would result in an additional ", letForestsRegenerate(input$percent_slider), " tons of carbon sequestered.")
})
```

```{r echo= FALSE}
if (params$user== "Scientist"){
  cat("*The above values were calculated by calculating the average FCI of naturally generated forests in the state. This average FCI value was then multiplied by X percent of the total acreage of human-planted forests in the state to yield the total carbon that would be stored if that amount of forest was naturally generated.")
}
```


### Risks & Issues  

Changing the status quo always comes with trade-offs. Restricting the ability of the forest products industry to replant in commercially favorable species will be unpopular. However, keep these facts in mind:  

* A **reduction** does not equal an **elimination** of forest products or the forest products industry  

* The more reliant a community is on either export industries or the wood products industry, the more likely it is to suffer from higher levels of poverty and unemployment  

* Forest industry work is dangerous -- logging has the second highest fatality rate of all job categories  

* Forest industry workers are older and not being replaced by younger generations because of issues around job security, self-employment, and danger. 

* Plantations require regular, costly human intervention that is often subsidized by government programs, including repeated thinnings and pesticide applications.  

* Plantations provide substantially less water filtering, wildlife habitat, and carbon sequestration than natural forests.  

We are not legislators, however, we can envision a reduction in forest harvest through taking legislative action such as:  

* Reducing subsidies paid to wood products companies  

* Reducing subsidies in state forest planting programs that clearly favor commercial species  

* Enacting more regulations on logging to improve carbon sequestration, water and air quality, wildlife habitat, canopy retention, and the availability of seed trees for regeneration.  

## Next Steps & Resources 

Do you want to act on this information, but you’re not sure where to go? We’ve got you covered! Here are some links…

All data gathered from:
USDA Forest Service, Forest Inventory and Analysis Program, Tue Mar 31 13:53:53 GMT 2020. Forest Inventory EVALIDator web-application Version 1.8.0.01. St. Paul, MN: U.S. Department of Agriculture, Forest Service, Northern Research Station. [Available only on internet: http://apps.fs.usda.gov/Evalidator/evalidator.jsp]
